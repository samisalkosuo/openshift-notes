= OpenShift configuration
:toc: left
:toc-title: Table of Contents

This document describes how to do various configuration in OpenShift.

== External registry

External registry is image registry for containers that should be available for OpenShift but, for any reason, not available from public registry or internal image registry.

The most obvious use case for external registry is for the airgapped OpenShift installation.

* Open link:../config.sh[config.sh]
** Find and modify _OCP_EXTERNAL_REGISTRY*_ environment variables to match your preferences.
* During installation a mirror registry was created but that is used only for OpenShift images.
* The name for the external registry is:
** _external-registry_, this name was added to registry certificate during installation.
* External registry uses the same certificate as mirror registry.
* Create external registry in bastion server:
** `sh omg.sh create-external-registry`
* Registry container is controlled using systemctl.

=== Configure OpenShift

When using external registry in OpenShift, pull secret is required so that pods can pull images from the registry.

Pull secret can be added for project or it can be added global cluster pull secret, that is used here. See also documentation about https://docs.openshift.com/container-platform/4.6/openshift_images/managing_images/using-image-pull-secrets.html#images-update-global-pull-secret_using-image-pull-secrets[using image pull secrets].

Update global pull secret:

* Open shell and login to OpenShift using cluster administrator rights.
* Script link:external-registry/update_global_pull_secret.sh[update_global_pull_secret.sh] is used to add or edit global pull secret:
** `sh update_global_pull_secret.sh https://external-registry.forum.fi.ibm.com:5001 admin passw0rd`
* Global pull secret is rolled out to each node in the cluster.

=== Images

Push images to external registry:

* Pull image from public registry.
** If using airgapped OpenShift pull image from Internet, save it, copy to bastion and load it locally.
* Login to external registry, for example:
** `podman login -u admin -p passw0rd external-registry.forum.fi.ibm.com:5001`
* Tag image:
** `podman tag <image> external-registry.forum.fi.ibm.com:5001/<myimage>`
* Push image:
** `podman push external-registry.forum.fi.ibm.com:5001/<myimage>`
* Use image in YAML files etc.

== NFS client provisioner

https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner[Kubernetes NFS-Client Provisioner] provides dynamic provisioning using existing NFS server. Great way to provide initial storage class for OpenShift.

=== Online installation

* Follow instructions in https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner.

=== Airgapped installation

Since OpenShift does not have access to Internet, extra steps are required to install provisioner.

* Login to jump server.
* Package provisioner image and deplyment files using link:nfs-client-provisioner/package_provisioner_image.sh[save_provisioner_image.sh]:
** `sh package_provisioner_image.sh`
* Copy _nfs-client-provisioner-files.tar_ to bastion server.
* Login to bastion server.
* Extract _nfs-client-provisioner-files.tar_:
** `tar -xf nfs-client-provisioner-files.tar`
* Change to _nfs-client-provisioner_-directory.
* Load provisioner image:
** `podman load < nfs-client-provisioner.tar`
* Tag image:
** `podman tag nfs-client-provisioner external-registry.forum.fi.ibm.com:5001/nfs-client-provisioner:latest`
* Push image:
** `podman push external-registry.forum.fi.ibm.com:5001/nfs-client-provisioner:latest`
* If you have NFS server, you need info about it.
** Or set your own NFS as described in the next section.
* Open _deployment.yaml_.
* Find _image_-entry and change to correct provisioner image. For example:
** `external-registry.forum.fi.ibm.com:5001/nfs-client-provisioner:latest`
* Set IP address and path of your NFS server.
* Login as cluster administrator using oc-client.
* Setup provisioner:
** `oc create -f rbac.yaml`
** `oc create -f deployment.yaml`
** `oc create -f class.yaml`
* Test by creating persistent volume claim:
** `oc create -f test-claim.yaml`
** There should test-claim directory in the NFS server.
* Get storage class:
** `oc get sc`
** And you should see _managed-nfs-storage_-storageclass.
* Optionally set _managed-nfs-storage_-storageclass as default:
** `oc patch storageclass managed-nfs-storage -p '{"metadata": {"annotations":{"storageclass.kubernetes.io/is-default-class":"true"}}}'`

==== NFS server

As an example, NFS server can be installed on the bastion server.

* Execute script link:nfs-client-provisioner/setup_nfs_server.sh[setup_nfs_server.sh]:
** `sh setup_nfs_server.sh`
** Script sets up NFS server using directory _/mnt/nfs_share_.
** NFS server allows clients from OpenShift internal network. Internal network is set using _OCP_DHCP_NETWORK_- environment variable set in link:../config.sh[config.sh].

== Internal image registry

Configure internal image registry


== Trusted certificate

== LDAP

OpenLDAP for demo https://github.com/samisalkosuo/openldap-docker